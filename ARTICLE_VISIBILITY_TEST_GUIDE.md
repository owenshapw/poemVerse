# 文章可见性控制功能测试指南

## 测试流程更新

### 改进后的用户流程

**之前的流程**：
1. 创建文章页面 → 预览页面 → 发布成功 → 返回创建页面 → 返回我的文章页面
2. 用户看不到刚发布的作品，需要手动刷新

**改进后的流程**：
1. 创建文章页面 → 预览页面 → 发布成功 → **直接跳转到作者作品集页面**
2. 用户立即看到刚发布的作品，可以立即设置可见性

## 详细测试步骤

### 1. 新文章发布流程测试

1. **登录用户账号**
2. **点击"发布诗篇"或"开始创作"**
3. **填写标题和内容**
4. **上传配图**（可选）
5. **点击"文字布局"进入预览页面**
6. **调整文字位置**（可选）
7. **点击"发布"按钮**
8. **验证：应该直接跳转到作者作品集页面**
9. **验证：刚发布的文章应该显示在列表中**
10. **验证：可以看到可见性控制元素**

### 2. 可见性控制功能测试

#### 在作者作品集页面（AuthorWorksScreen）：

1. **验证权限控制**：
   - 登录作者本人：应该看到可见性控制元素
   - 其他用户/未登录：不应该看到控制元素

2. **验证UI元素**：
   - 右上角圆形图标：公开=地球图标（绿色），私密=锁定图标（橙色）
   - 底部状态条：显示"在首页展示"或"仅个人可见"
   - 切换按钮：显示"隐藏"或"公开"

3. **验证切换功能**：
   - 点击右上角图标或底部按钮
   - 应该显示加载提示
   - 成功后应该显示成功消息
   - UI状态应该立即更新

4. **验证服务器同步**：
   - 切换可见性后刷新页面
   - 状态应该保持

### 3. 首页过滤测试

1. **设置文章为私密**
2. **访问首页**（未登录状态）
3. **验证：私密文章不应该出现在首页**
4. **设置文章为公开**
5. **刷新首页**
6. **验证：公开文章应该出现在首页**

### 4. 导航流程测试

1. **从我的文章页面创建新文章**
2. **发布成功后应该跳转到作品集**
3. **从作品集返回**
4. **验证：我的文章页面应该显示最新数据**

### 5. 错误处理测试

1. **网络断开时切换可见性**
2. **验证：应该显示错误提示**
3. **验证：UI状态应该回滚**

1. **非作者用户尝试切换可见性**（通过API调用）
2. **验证：应该返回权限错误**

## 预期结果

### ✅ 成功指标

- [ ] 新文章发布后直接跳转到作品集页面
- [ ] 只有作者本人能看到可见性控制元素
- [ ] 可见性切换功能正常工作
- [ ] 私密文章不在首页显示
- [ ] 公开文章正常在首页显示
- [ ] 状态变化有适当的视觉反馈
- [ ] 错误情况有合适的提示
- [ ] 数据在页面间正确同步

### 🎯 用户体验目标

1. **直观性**：用户能立即理解什么是公开/私密
2. **即时性**：发布后立即看到作品和控制选项
3. **可靠性**：状态切换稳定，数据同步正确
4. **安全性**：只有作者能控制自己的作品

## 常见问题排查

### 问题：发布后没有跳转到作品集
- 检查 `article_preview_screen.dart` 中的导航逻辑
- 确认 `Navigator.pushReplacement` 调用正常

### 问题：看不到可见性控制元素
- 检查用户是否已登录
- 确认当前用户是否为文章作者
- 检查 `_isCurrentUserAuthor` 状态

### 问题：可见性切换失败
- 检查网络连接
- 确认后端API端点已部署
- 检查JWT token是否有效

### 问题：首页仍显示私密文章
- 确认后端查询逻辑已更新
- 检查数据库 `is_public_visible` 字段
- 清除应用缓存后重试

## 测试数据准备

### 数据库检查
```sql
-- 检查文章的可见性状态
SELECT id, title, author, is_public_visible, created_at 
FROM articles 
ORDER BY created_at DESC 
LIMIT 10;

-- 检查某个用户的文章
SELECT id, title, is_public_visible 
FROM articles 
WHERE user_id = 'your-user-id';
```

### API测试
```bash
# 测试可见性更新API
curl -X PATCH "https://your-api-url/articles/{article_id}/visibility" \
     -H "Authorization: Bearer {your_token}" \
     -H "Content-Type: application/json" \
     -d '{"is_public_visible": false}'
```

## 回归测试

确保以下现有功能仍然正常：
- [ ] 文章创建和编辑
- [ ] 文章删除
- [ ] 图片上传和显示
- [ ] 文字位置调整
- [ ] 点赞功能
- [ ] 文章预览和分享